# CelFund Vercel Deployment Guide

## üöÄ Quick Deployment Steps

### Step 1: Push Code to GitHub
```bash
cd /path/to/celfund-dev
git add .
git commit -m "Ready for Vercel deployment"
git push origin main
```

### Step 2: Connect Vercel to GitHub

1. Go to [vercel.com](https://vercel.com)
2. Click **"Add New Project"**
3. Select **"Import Git Repository"**
4. Choose your GitHub repo: `celerfirstdev/celfund-dev`
5. Click **"Import"**

### Step 3: Configure Project Settings

**Framework Preset:** Select "Create React App"

**Root Directory:** Leave as default (uses monorepo detection)

**Build Settings:**
- Build Command: `cd frontend && yarn build`
- Output Directory: `frontend/build`
- Install Command: `cd frontend && yarn install`

### Step 4: Set Up Vercel Postgres

1. In your Vercel project, go to **Storage** tab
2. Click **"Create Database"**
3. Select **"Postgres"**
4. Choose a region (closest to your users)
5. Click **"Create"**
6. Vercel will automatically add `POSTGRES_URL` to your environment variables

### Step 5: Add Environment Variables

Go to **Settings ‚Üí Environment Variables** and add:

#### Production Environment Variables:

```bash
# Frontend URL (will be auto-generated by Vercel)
FRONTEND_URL=https://celfund.vercel.app

# Stripe Keys (Get from dashboard.stripe.com)
STRIPE_SECRET_KEY=sk_test_xxx  # Replace with your actual key
STRIPE_PUBLISHABLE_KEY=pk_test_xxx  # Replace with your actual key
STRIPE_PRICE_ID=price_xxx  # Replace with your actual price ID

# Airtable Webhook
AIRTABLE_WEBHOOK_URL=https://hooks.airtable.com/workflows/v1/genericWebhook/appm8zgsZ3r90PBrs/wflIYX3L8jgwHupRC/wtrQDd2Nchl5ptqK9

# Database (auto-added by Vercel Postgres)
POSTGRES_URL=postgresql://...

# React App Backend URL
REACT_APP_BACKEND_URL=https://celfund.vercel.app

# CORS
CORS_ORIGINS=*
```

### Step 6: Deploy

1. Click **"Deploy"**
2. Wait 2-3 minutes for build to complete
3. Your app will be live at: `https://celfund.vercel.app`

### Step 7: Set Up Custom Domain (Optional)

1. Go to **Settings ‚Üí Domains**
2. Click **"Add Domain"**
3. Enter your domain: `celfund.com`
4. Follow DNS configuration instructions
5. Vercel will automatically provision SSL certificate

**DNS Configuration Example:**
```
Type: A
Name: @
Value: 76.76.21.21

Type: CNAME
Name: www
Value: celfund.vercel.app
```

---

## üìã Code Changes Needed

### 1. Update Backend for Postgres (Instead of MongoDB)

The app currently uses MongoDB. For Vercel, update `server.py`:

```python
# Replace MongoDB imports with Postgres
from database_postgres import PostgresDatabase

# Initialize Postgres
postgres_url = os.environ.get('POSTGRES_URL')
database = PostgresDatabase(postgres_url)

# Initialize database tables on startup
@app.on_event("startup")
async def startup():
    await database.initialize()
```

### 2. Update requirements.txt

Add PostgreSQL driver:
```bash
cd /app/backend
echo "asyncpg>=0.29.0" >> requirements.txt
```

### 3. Create Vercel Serverless Functions

Create `/app/api` directory for serverless functions:

```bash
mkdir -p /app/api
```

Each endpoint becomes a serverless function.

---

## üîß Backend Configuration for Vercel

### Option A: Serverless Functions (Recommended)

Create `/app/api/match.py`:
```python
from http.server import BaseHTTPRequestHandler
import json
from backend.grant_matcher import GrantMatcher
from backend.database_postgres import PostgresDatabase
import os

matcher = GrantMatcher()
db = PostgresDatabase(os.environ['POSTGRES_URL'])

class handler(BaseHTTPRequestHandler):
    def do_POST(self):
        content_length = int(self.headers['Content-Length'])
        body = self.rfile.read(content_length)
        data = json.loads(body)
        
        # Match grants
        grants = await matcher.match_grants(
            project_summary=data['project_summary'],
            focus_area=data['focus_area']
        )
        
        # Save to database
        submission_id = await db.save_submission(
            project_summary=data['project_summary'],
            email=data['email'],
            organization_type=data['organization_type'],
            focus_area=data['focus_area']
        )
        
        self.send_response(200)
        self.send_header('Content-type', 'application/json')
        self.end_headers()
        
        response = {
            'success': True,
            'grants': grants,
            'submission_id': submission_id
        }
        self.wfile.write(json.dumps(response).encode())
```

### Option B: Keep FastAPI Backend

If keeping FastAPI, add to `vercel.json`:
```json
{
  "builds": [
    {
      "src": "backend/server.py",
      "use": "@vercel/python"
    }
  ]
}
```

---

## üéØ Stripe Production Setup

### Get Production Keys:

1. Go to [dashboard.stripe.com](https://dashboard.stripe.com)
2. Toggle **"Test mode"** to **OFF** (production mode)
3. Go to **Developers ‚Üí API Keys**
4. Copy:
   - **Publishable key**: `pk_live_...`
   - **Secret key**: `sk_live_...`

### Create Product:

1. Go to **Products**
2. Click **"Add product"**
3. Name: "CelFund Pro"
4. Price: $39/month
5. Copy the **Price ID**: `price_...`

### Update Environment Variables:

Replace test keys with production keys in Vercel dashboard.

---

## üß™ Testing Deployment

### Test Grant Matching:
```bash
curl -X POST https://celfund.vercel.app/api/match \
  -H "Content-Type: application/json" \
  -d '{
    "project_summary": "Community water project",
    "organization_type": "nonprofit",
    "focus_area": "community",
    "email": "test@celfund.com"
  }'
```

### Test Stripe Checkout:
```bash
curl -X POST https://celfund.vercel.app/api/create-checkout-session \
  -H "Content-Type: application/json" \
  -d '{"email": "test@celfund.com"}'
```

---

## üö® Common Issues & Solutions

### Issue 1: Build Fails - "Module not found"
**Solution:** Ensure all dependencies are in `package.json` and `requirements.txt`

### Issue 2: API Routes Return 404
**Solution:** Check `vercel.json` routes configuration. All API routes should start with `/api/`

### Issue 3: Database Connection Fails
**Solution:** Verify `POSTGRES_URL` is set in Vercel environment variables

### Issue 4: CORS Errors
**Solution:** Update CORS_ORIGINS to include your Vercel domain

### Issue 5: Stripe Checkout Fails
**Solution:** Verify production Stripe keys are set and price ID is correct

---

## üìä Monitoring

### Vercel Analytics
- Go to **Analytics** tab in Vercel dashboard
- View page views, performance metrics, and errors

### Vercel Logs
- Go to **Deployments** ‚Üí Select deployment ‚Üí **Logs**
- View real-time function execution logs

### Database Monitoring
- Go to **Storage** ‚Üí **Postgres** ‚Üí **Insights**
- Monitor queries, connections, and performance

---

## üîê Security Checklist

- [ ] All API keys in environment variables (not in code)
- [ ] Stripe production keys configured
- [ ] CORS properly configured for production domain
- [ ] Rate limiting enabled (Vercel Pro plan)
- [ ] Database connection pooling configured
- [ ] HTTPS/SSL automatically enabled by Vercel
- [ ] IP hashing for privacy in database

---

## üéâ Go Live Checklist

- [ ] Code pushed to GitHub main branch
- [ ] Vercel project created and connected
- [ ] Vercel Postgres database created
- [ ] All environment variables set
- [ ] Database tables initialized
- [ ] Stripe production keys configured
- [ ] Custom domain configured (optional)
- [ ] SSL certificate active
- [ ] Test all features in production
- [ ] Airtable webhook tested
- [ ] Grant matching tested with real queries
- [ ] Payment flow tested with real Stripe

---

## üìû Support Resources

- **Vercel Docs:** https://vercel.com/docs
- **Vercel Postgres:** https://vercel.com/docs/storage/vercel-postgres
- **Stripe Docs:** https://stripe.com/docs
- **CelFund Issues:** https://github.com/celerfirstdev/celfund-dev/issues

---

## üöÄ Expected Final URLs

- **Production:** https://celfund.vercel.app (or your custom domain)
- **API:** https://celfund.vercel.app/api/match
- **Success Page:** https://celfund.vercel.app/success
- **Stripe Checkout:** Redirects to checkout.stripe.com

---

**Deployment Time:** ~5-10 minutes  
**Build Time:** ~2-3 minutes per deployment  
**Zero Downtime:** Vercel handles deployments with zero downtime
